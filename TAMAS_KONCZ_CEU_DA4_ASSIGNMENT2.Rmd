---
title: "DA4 -  Assignment 1"
author: "Tamas Koncz"
date: '2018-02-11'
output:
  html_document:
    df_print: paged
  html_notebook:
    df_print: paged
  pdf_document: default
---

```{r setup, message=FALSE, include=FALSE}
library(data.table)

library(ggplot2)
library(gridExtra)
library(scales)

library(caret)

library(skimr)
library(knitr)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)

theme_set(theme_minimal())   # globally set ggplot theme

set.seed(93)
RMSE <- function(x, true_x) sqrt(mean((x - true_x)^2))
ERR_SQ <- function(x, true_x) (x - true_x)^2
```


```{r, include= FALSE}
# rm(list=ls())
# x <- fread("./Data/bisnode_all.csv",
#               stringsAsFactors = FALSE)
# 
# print(skim(data))
```

```{r}
data <- copy(x)
```

Look at missing values in the dataset:
```{r}
missing_values <- as.data.table(t(data[, lapply(.SD, function(x) sum(is.na(x))), .SDcols = names(data)]), keep.rownames=TRUE)
setnames(missing_values, c("variable", "NA.Count"))

missing_values[order(-NA.Count)][NA.Count>0]
```
  
Removing observations where curr_assets (or curr_liab) is missing:
```{r}
data <- data[!is.na(curr_assets) && !is.na(curr_liab)]
```
  
  
Remove some variables that are likely not useful, given the very large number of NAs:
```{r}
data[, c("D", 
         "COGS", 
         "finished_prod", 
         "exit_year",
         "wages") := NULL]


data[sales == 0, .N]

```



```{r}
p1 <- ggplot(data= data, aes(x= log(curr_liab))) + geom_density()
p2 <- ggplot(data= data, aes(x= log(curr_assets))) + geom_histogram()

grid.arrange(p1, p2, ncol = 2)
```

```{r}
data <- data[, .(comp_id, 
                  year= year, 
                  curr_liab= curr_liab,
                  curr_assets= curr_assets,
                  curr_sales= sales,
                  founded_year = founded_year)]

data_prev <- data[,.(comp_id, 
                     year= year + 1, 
                     prev_liab= curr_liab,
                     prev_assets= curr_assets,
                     prev_sales= curr_sales,
                     prev_founded_year = founded_year)]

data_prev2 <- data[,.(comp_id, 
                     year= year + 2, 
                     prev_2_liab= curr_liab,
                     prev_2_assets= curr_assets,
                     prev_2_sales= curr_sales)]

data_prev <- merge(x = data_prev, y = data_prev2, by = c("comp_id", "year"), all.x = TRUE) #all.x --> fine with missing T-2 data


dt <- merge(x = data, y = data_prev, by = c("comp_id", "year"), all.y = TRUE)

dt <- dt[year != 2012 &
          year != 2013 &
          year != 2017]

dt[, is_defaulted := ifelse((curr_liab > 0 & prev_liab > 0) & 
                              (curr_sales == 0 & prev_sales > 0), 
                            1, 0)]

dt[, .(.N, 
       sum(is_defaulted)), 
   keyby = year]
```


```{r}
#prev liab vs curr liab
ggplot(data = dt, aes(x= prev_liab, y= curr_liab)) + 
  geom_point(alpha=.1) + 
  scale_y_continuous(trans = 'log10',
                        breaks = trans_breaks('log10', function(x) 10^x),
                        labels = trans_format('log10', math_format(10^.x))) + 
  scale_x_continuous(trans = 'log10',
                        breaks = trans_breaks('log10', function(x) 10^x),
                        labels = trans_format('log10', math_format(10^.x)))

#curr assets vs curr liab
ggplot(data = dt, aes(x= curr_assets, y= curr_liab)) + 
  geom_point(alpha=.1) + 
  scale_y_continuous(trans = 'log10',
                        breaks = trans_breaks('log10', function(x) 10^x),
                        labels = trans_format('log10', math_format(10^.x))) + 
  scale_x_continuous(trans = 'log10',
                        breaks = trans_breaks('log10', function(x) 10^x),
                        labels = trans_format('log10', math_format(10^.x)))  +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed") 


#curr assets vs curr liab
ggplot(data = dt, aes(x= curr_liab, y= curr_sales)) + 
  geom_point(alpha=.1) + 
  scale_y_continuous(trans = 'log10',
                        breaks = trans_breaks('log10', function(x) 10^x),
                        labels = trans_format('log10', math_format(10^.x))) + 
  scale_x_continuous(trans = 'log10',
                        breaks = trans_breaks('log10', function(x) 10^x),
                        labels = trans_format('log10', math_format(10^.x)))  +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed") 

```


[Definition for default](https://www.investopedia.com/terms/d/default2.asp): "... debtor is unable to meet the legal obligation of debt repayment...". Hence, the first requirement is to have some obligations to begin with.  
The definition of default for this exercise will follow the same logic: looking at companies who had any liabilities during a year, but their performance deteoriated significantly the next.